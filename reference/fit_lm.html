<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="description" content='The fit_lm and adjust_lm functions facilitate linear model-based
normalization of abundance matrices. The expected noise in a numeric
data matrix can be modeled with a linear regression model using the
fit_lm function and the data can subsequently be adjusted using the
adjust_lm function (i.e., the modeled noise will be removed from the
abundance values). A typical use case would be to remove injection index
dependent signal drifts in a LC-MS derived metabolomics data:
a linear model of the form y ~ injection_index could be used to model
the measured abundances of each feature (each row in a data matrix) as a
function of the injection index in which a specific sample was measured
during the LC-MS measurement run. The fitted linear regression models
can subsequently be used to adjust the abundance matrix by removing
these dependencies from the data. This allows to perform signal
adjustments as described in (Wehrens et al. 2016).
The two functions are described in more details below:
fit_lm allows to fit a linear regression model (defined with parameter
formula) to each row of the numeric data matrix submitted with parameter
y. Additional covariates of the linear model defined in formula are
expected to be provided as columns in a data.frame supplied via
the data parameter.
The linear model is expected to be defined by a formula starting with
y ~ . To model for example an injection index dependency of values in
y a formula y ~ injection_index could be used, with values for the
injection index being provided as a column "injection_index" in the
data data frame. fit_lm would thus fit this model to each row of
y.
Linear models can be fitted either with the standard least squares of
lm() by setting method = "lm" (the default), or with the more robust
methods from the robustbase package with method = "lmrob".
adjust_lm can be used to adjust abundances in a data matrix y based
on linear regression models provided with parameter lm. Parameter lm
is expected to be a list of length equal to the number of rows of y,
each element being a linear model (i.e., a results from lm or lmrob).
Covariates for the model need to be provided as columns in a data.frame
provided with parameter data. The number of rows of that data.frame
need to match the number of columns of y. The function returns the
input matrix y with values in rows adjusted with the linear models
provided by lm. No adjustment is performed for rows for which the
respective element in lm is NA. See examples below for details or the
vignette for more examples, descriptions and information.'><title>Linear model-based normalization of abundance matrices — fit_lm • MetaboCoreUtils</title><!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png"><link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png"><link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png"><link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png"><link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png"><link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png"><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous"><!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Linear model-based normalization of abundance matrices — fit_lm"><meta property="og:description" content='The fit_lm and adjust_lm functions facilitate linear model-based
normalization of abundance matrices. The expected noise in a numeric
data matrix can be modeled with a linear regression model using the
fit_lm function and the data can subsequently be adjusted using the
adjust_lm function (i.e., the modeled noise will be removed from the
abundance values). A typical use case would be to remove injection index
dependent signal drifts in a LC-MS derived metabolomics data:
a linear model of the form y ~ injection_index could be used to model
the measured abundances of each feature (each row in a data matrix) as a
function of the injection index in which a specific sample was measured
during the LC-MS measurement run. The fitted linear regression models
can subsequently be used to adjust the abundance matrix by removing
these dependencies from the data. This allows to perform signal
adjustments as described in (Wehrens et al. 2016).
The two functions are described in more details below:
fit_lm allows to fit a linear regression model (defined with parameter
formula) to each row of the numeric data matrix submitted with parameter
y. Additional covariates of the linear model defined in formula are
expected to be provided as columns in a data.frame supplied via
the data parameter.
The linear model is expected to be defined by a formula starting with
y ~ . To model for example an injection index dependency of values in
y a formula y ~ injection_index could be used, with values for the
injection index being provided as a column "injection_index" in the
data data frame. fit_lm would thus fit this model to each row of
y.
Linear models can be fitted either with the standard least squares of
lm() by setting method = "lm" (the default), or with the more robust
methods from the robustbase package with method = "lmrob".
adjust_lm can be used to adjust abundances in a data matrix y based
on linear regression models provided with parameter lm. Parameter lm
is expected to be a list of length equal to the number of rows of y,
each element being a linear model (i.e., a results from lm or lmrob).
Covariates for the model need to be provided as columns in a data.frame
provided with parameter data. The number of rows of that data.frame
need to match the number of columns of y. The function returns the
input matrix y with values in rows adjusted with the linear models
provided by lm. No adjustment is performed for rows for which the
respective element in lm is NA. See examples below for details or the
vignette for more examples, descriptions and information.'><meta property="og:image" content="https://rformassspectrometry.github.io/MetaboCoreUtils/logo.png"><!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-dark navbar-expand-lg bg-primary" data-bs-theme="dark"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">MetaboCoreUtils</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.11.3</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="nav-item">
  <a class="nav-link" href="../articles/MetaboCoreUtils.html">Get started</a>
</li>
<li class="active nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul><form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off"></form>

      <ul class="navbar-nav"><li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/RforMassSpectrometry/MetaboCoreUtils/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul></div>

    
  </div>
</nav><div class="container template-reference-topic">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Linear model-based normalization of abundance matrices</h1>
      <small class="dont-index">Source: <a href="https://github.com/RforMassSpectrometry/MetaboCoreUtils/blob/HEAD/R/normalization.R" class="external-link"><code>R/normalization.R</code></a></small>
      <div class="d-none name"><code>fit_lm.Rd</code></div>
    </div>

    <div class="ref-description section level2">
    <p>The <code>fit_lm</code> and <code>adjust_lm</code> functions facilitate linear model-based
normalization of abundance matrices. The expected noise in a numeric
data matrix can be modeled with a linear regression model using the
<code>fit_lm</code> function and the data can subsequently be adjusted using the
<code>adjust_lm</code> function (i.e., the modeled noise will be removed from the
abundance values). A typical use case would be to remove injection index
dependent signal drifts in a LC-MS derived metabolomics data:
a linear model of the form <code>y ~ injection_index</code> could be used to model
the measured abundances of each feature (each row in a data matrix) as a
function of the injection index in which a specific sample was measured
during the LC-MS measurement run. The fitted linear regression models
can subsequently be used to adjust the abundance matrix by removing
these dependencies from the data. This allows to perform signal
adjustments as described in (Wehrens et al. 2016).</p>
<p>The two functions are described in more details below:</p>
<p><code>fit_lm</code> allows to fit a linear regression model (defined with parameter
<code>formula</code>) to each row of the numeric data matrix submitted with parameter
<code>y</code>. Additional covariates of the linear model defined in <code>formula</code> are
expected to be provided as columns in a <code>data.frame</code> supplied <em>via</em>
the <code>data</code> parameter.</p>
<p>The linear model is expected to be defined by a formula starting with
<code>y ~ </code>. To model for example an injection index dependency of values in
<code>y</code> a formula <code>y ~ injection_index</code> could be used, with values for the
injection index being provided as a column <code>"injection_index"</code> in the
<code>data</code> data frame. <code>fit_lm</code> would thus fit this model to each row of
<code>y</code>.</p>
<p>Linear models can be fitted either with the standard least squares of
<code><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm()</a></code> by setting <code>method = "lm"</code> (the default), or with the more robust
methods from the <em>robustbase</em> package with <code>method = "lmrob"</code>.</p>
<p><code>adjust_lm</code> can be used to adjust abundances in a data matrix <code>y</code> based
on linear regression models provided with parameter <code>lm</code>. Parameter <code>lm</code>
is expected to be a <code>list</code> of length equal to the number of rows of <code>y</code>,
each element being a linear model (i.e., a results from <code>lm</code> or <code>lmrob</code>).
Covariates for the model need to be provided as columns in a <code>data.frame</code>
provided with parameter <code>data</code>. The number of rows of that <code>data.frame</code>
need to match the number of columns of <code>y</code>. The function returns the
input matrix <code>y</code> with values in rows adjusted with the linear models
provided by <code>lm</code>. No adjustment is performed for rows for which the
respective element in <code>lm</code> is <code>NA</code>. See examples below for details or the
vignette for more examples, descriptions and information.</p>
    </div>

    <div class="section level2">
    <h2 id="ref-usage">Usage<a class="anchor" aria-label="anchor" href="#ref-usage"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">fit_lm</span><span class="op">(</span></span>
<span>  <span class="va">formula</span>,</span>
<span>  <span class="va">data</span>,</span>
<span>  <span class="va">y</span>,</span>
<span>  method <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"lm"</span>, <span class="st">"lmrob"</span><span class="op">)</span>,</span>
<span>  control <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  minVals <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">ceiling</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span> <span class="op">*</span> <span class="fl">0.75</span><span class="op">)</span>,</span>
<span>  model <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  <span class="va">...</span>,</span>
<span>  BPPARAM <span class="op">=</span> <span class="fu">SerialParam</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu">adjust_lm</span><span class="op">(</span>y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="op">)</span>, data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="op">)</span>, lm <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span>, <span class="va">...</span><span class="op">)</span></span></code></pre></div>
    </div>

    <div class="section level2">
    <h2 id="arguments">Arguments<a class="anchor" aria-label="anchor" href="#arguments"></a></h2>
    <dl><dt>formula</dt>
<dd><p><code>formula</code> defining the model that should be fitted to the
data. See also <code><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm()</a></code> for more information. Formulas should begin
with <code>y ~ </code> as values in rows of <code>y</code> will be defined as <em>y</em>. See
description of the <code>fit_lm</code> function for more information.</p></dd>


<dt>data</dt>
<dd><p><code>data.frame</code> containing the covariates for the linear model
defined by <code>formula</code> (for <code>fit_lm</code>) or used in <code>lm</code> (for <code>adjust_lm</code>).
The number of rows has to match the number of columns of <code>y</code>.</p></dd>


<dt>y</dt>
<dd><p>for <code>fit_lm</code>: <code>matrix</code> of abundances on which the linear model
pefined with <code>formula</code> should be fitted. For <code>adjust_lm</code>: <code>matrix</code>
of abundances that should be adjusted using the models provided with
parameter <code>lm</code>.</p></dd>


<dt>method</dt>
<dd><p><code>character(1)</code> defining the linear regression function that
should be used for model fitting. Can be either <code>method = "lm"</code> (the
default) for standard least squares model fitting or <code>method = "lmrob"</code>
for a robust alternative defined in the <em>robustbase</em> package.</p></dd>


<dt>control</dt>
<dd><p>a <code>list</code> speficying control parameters for <code>lmrob</code>. Only
used if <code>method = "lmrob"</code>. See help of <code>lmrob.control</code> in the
<code>robustbase</code> package for details. By default <code>control = NULL</code> the
<em>KS2014</em> settings are used and scale-finding iterations are increased
to 10000.</p></dd>


<dt>minVals</dt>
<dd><p><code>numeric(1)</code> defining the minimum number of non-missing
values (per feature/row) required to perform the model fitting. For
rows in <code>y</code> for which fewer non-<code>NA</code> values are available no model
will be fitted and a <code>NA</code> will be reported instead.</p></dd>


<dt>model</dt>
<dd><p><code>logical(1)</code> whether the model frame are included in the
returned linear models. Passed to the <code>lm</code> or <code>lmrob</code> functions.</p></dd>


<dt>...</dt>
<dd><p>for <code>fit_lm</code>: additional parameters to be passed to the
downstream calls to <code>lm</code> or <code>lmrob</code>. For <code>adjust_lm</code>: ignored.</p></dd>


<dt>BPPARAM</dt>
<dd><p>parallel processing setup. See <code>bpparam()</code> for more
information. Parallel processing can improve performance especially
for <code>method = "lmrob"</code>.</p></dd>


<dt>lm</dt>
<dd><p><code>list</code> of linear models (as returned by <code>lm</code> or <code>lmrob</code>) such
as returned by the <code>fit_lm</code> function. The length of the list is
expected to match the number of rows of <code>y</code>, i.e., each element
should be a linear model to adjust the specific row, or <code>NA</code> to skip
adjustment for that particular row in <code>y</code>.</p></dd>

</dl></div>
    <div class="section level2">
    <h2 id="value">Value<a class="anchor" aria-label="anchor" href="#value"></a></h2>
    

<p></p><div class="sourceCode"><pre><code><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a>For <span class="st">`</span><span class="at">fit_lm</span><span class="st">`</span><span class="sc">:</span> a <span class="st">`</span><span class="at">list</span><span class="st">`</span> with linear <span class="fu">models</span> (either of type <span class="sc">*</span>lm<span class="sc">*</span> or</span>
<span id="cb1-2"><a href="#cb1-2" tabindex="-1"></a><span class="sc">*</span>lmrob<span class="sc">*</span>) or length equal to the number of rows of <span class="st">`</span><span class="at">y</span><span class="st">`</span>. <span class="st">`</span><span class="at">NA</span><span class="st">`</span> is</span>
<span id="cb1-3"><a href="#cb1-3" tabindex="-1"></a>reported <span class="cf">for</span> rows with too few non<span class="sc">-</span>missing data <span class="fu">points</span> (depending</span>
<span id="cb1-4"><a href="#cb1-4" tabindex="-1"></a>on parameter <span class="st">`</span><span class="at">minValues</span><span class="st">`</span>).</span>
<span id="cb1-5"><a href="#cb1-5" tabindex="-1"></a>For <span class="st">`</span><span class="at">adjust_lm</span><span class="st">`</span><span class="sc">:</span> a numeric <span class="fu">matrix</span> (same dimensions as input matrix</span>
<span id="cb1-6"><a href="#cb1-6" tabindex="-1"></a><span class="st">`</span><span class="at">y</span><span class="st">`</span>) with the values adjusted with the provided linear models.</span></code></pre><p></p></div>


    </div>
    <div class="section level2">
    <h2 id="references">References<a class="anchor" aria-label="anchor" href="#references"></a></h2>
    <p>Wehrens R, Hageman JA, van Eeuwijk F, Kooke R, Flood PJ, Wijnker E,
Keurentjes JJ, Lommen A, van Eekelen HD, Hall RD Mumm R and de Vos RC.
Improved batch correction in untargeted MS-based metabolomics.
<em>Metabolomics</em> 2016; 12:88.</p>
    </div>
    <div class="section level2">
    <h2 id="author">Author<a class="anchor" aria-label="anchor" href="#author"></a></h2>
    <p>Johannes Rainer</p>
    </div>

    <div class="section level2">
    <h2 id="ref-examples">Examples<a class="anchor" aria-label="anchor" href="#ref-examples"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">## See also the vignette for more details and examples.</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">## Load a test matrix with abundances of features from a LC-MS experiment.</span></span></span>
<span class="r-in"><span><span class="va">vals</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html" class="external-link">read.table</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"txt"</span>, <span class="st">"feature_values.txt"</span>,</span></span>
<span class="r-in"><span>                                package <span class="op">=</span> <span class="st">"MetaboCoreUtils"</span><span class="op">)</span>, sep <span class="op">=</span> <span class="st">"\t"</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">vals</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="va">vals</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">## Define a data.frame with the covariates to be used to model the noise</span></span></span>
<span class="r-in"><span><span class="va">sdata</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>injection_index <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">vals</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">## Fit a linear model describing the feature abundances as a</span></span></span>
<span class="r-in"><span><span class="co">## function of the index in which samples were injected during the LC-MS</span></span></span>
<span class="r-in"><span><span class="co">## run. We're fitting the model to log2 transformed data.</span></span></span>
<span class="r-in"><span><span class="co">## Note that such a model should **only** be fitted if the samples</span></span></span>
<span class="r-in"><span><span class="co">## were randomized, i.e. the injection index is independent of any</span></span></span>
<span class="r-in"><span><span class="co">## experimental covariate. Alternatively, the injection order dependent</span></span></span>
<span class="r-in"><span><span class="co">## signal drift could be estimated using QC samples (if they were</span></span></span>
<span class="r-in"><span><span class="co">## repeatedly injected) - see vignette for more details.</span></span></span>
<span class="r-in"><span><span class="va">ii_lm</span> <span class="op">&lt;-</span> <span class="fu">fit_lm</span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="va">injection_index</span>, data <span class="op">=</span> <span class="va">sdata</span>, y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log2</a></span><span class="op">(</span><span class="va">vals</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">## The result is a list of linear models</span></span></span>
<span class="r-in"><span><span class="va">ii_lm</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Call:</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> lm(formula = formula, data = data, model = model)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Coefficients:</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     (Intercept)  injection_index  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>       14.833410         0.001587  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">## Plotting the data for one feature:</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">sdata</span><span class="op">$</span><span class="va">injection_index</span>, y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log2</a></span><span class="op">(</span><span class="va">vals</span><span class="op">[</span><span class="fl">2</span>, <span class="op">]</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>    ylab <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/expression.html" class="external-link">expression</a></span><span class="op">(</span><span class="va">log</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">~</span><span class="va">abundance</span><span class="op">)</span>, xlab <span class="op">=</span> <span class="st">"injection index"</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/graphics/grid.html" class="external-link">grid</a></span><span class="op">(</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="co">## plot also the fitted model</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span><span class="va">ii_lm</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span>, lty <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span></span>
<span class="r-plt img"><img src="fit_lm-1.png" alt="" width="700" height="433"></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">## For this feature (row) a decreasing signal intensity with injection</span></span></span>
<span class="r-in"><span><span class="co">## index was observed (and modeled).</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">## For another feature an increasing intensity can be observed.</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">sdata</span><span class="op">$</span><span class="va">injection_index</span>, y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log2</a></span><span class="op">(</span><span class="va">vals</span><span class="op">[</span><span class="fl">3</span>, <span class="op">]</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>    ylab <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/expression.html" class="external-link">expression</a></span><span class="op">(</span><span class="va">log</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">~</span><span class="va">abundance</span><span class="op">)</span>, xlab <span class="op">=</span> <span class="st">"injection index"</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/graphics/grid.html" class="external-link">grid</a></span><span class="op">(</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="co">## plot also the fitted model</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span><span class="va">ii_lm</span><span class="op">[[</span><span class="fl">3</span><span class="op">]</span><span class="op">]</span>, lty <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span></span>
<span class="r-plt img"><img src="fit_lm-2.png" alt="" width="700" height="433"></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">## This trend can be removed from the data using the `adjust_lm` function</span></span></span>
<span class="r-in"><span><span class="co">## by providing the linear models descring the drift. Note that, because</span></span></span>
<span class="r-in"><span><span class="co">## we're adjusting log2 transformed data, the resulting abundances are</span></span></span>
<span class="r-in"><span><span class="co">## also in log2 scale.</span></span></span>
<span class="r-in"><span><span class="va">vals_adj</span> <span class="op">&lt;-</span> <span class="fu">adjust_lm</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log2</a></span><span class="op">(</span><span class="va">vals</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">sdata</span>, lm <span class="op">=</span> <span class="va">ii_lm</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">## Plotting the data before (open circles) and after adjustment (filled</span></span></span>
<span class="r-in"><span><span class="co">## points)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">sdata</span><span class="op">$</span><span class="va">injection_index</span>, y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log2</a></span><span class="op">(</span><span class="va">vals</span><span class="op">[</span><span class="fl">2</span>, <span class="op">]</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>    ylab <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/expression.html" class="external-link">expression</a></span><span class="op">(</span><span class="va">log</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">~</span><span class="va">abundance</span><span class="op">)</span>, xlab <span class="op">=</span> <span class="st">"injection index"</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/graphics/points.html" class="external-link">points</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">sdata</span><span class="op">$</span><span class="va">injection_index</span>, y <span class="op">=</span> <span class="va">vals_adj</span><span class="op">[</span><span class="fl">2</span>, <span class="op">]</span>, pch <span class="op">=</span> <span class="fl">16</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/graphics/grid.html" class="external-link">grid</a></span><span class="op">(</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="co">## Adding the line fitted through the raw data</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span><span class="va">ii_lm</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span>, lty <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="co">## Adding a line fitted through the adjusted data</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">vals_adj</span><span class="op">[</span><span class="fl">2</span>, <span class="op">]</span> <span class="op">~</span> <span class="va">sdata</span><span class="op">$</span><span class="va">injection_index</span><span class="op">)</span>, lty <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span></span>
<span class="r-plt img"><img src="fit_lm-3.png" alt="" width="700" height="433"></span>
<span class="r-in"><span><span class="co">## After adjustment there is no more dependency on injection index.</span></span></span>
</code></pre></div>
    </div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p></p><p>Developed by Johannes Rainer, Michael Witting, Andrea Vicini, Sebastian Gibb, Roger Gine, Philippine Louail.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p><p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.8.9000.</p>
</div>

    </footer></div>

  

  

  </body></html>

